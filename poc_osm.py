#poc_osm.py
from pyproj import Proj, transform
from lxml import etree
import overpy

# Correct the GML input data by properly quoting attribute values
gml_data = '''
<gml:MultiSurface srsName="https://www.opengis.net/def/crs/EPSG/0/31370" xmlns:gml="http://www.opengis.net/gml/3.2"><gml:surfaceMember><gml:Polygon><gml:exterior><gml:LinearRing><gml:posList>210441.56589999795 181201.39449999854 210429.04190000147 181099.7613000013 210435.56889999658 181099.08929999918 210454.7050999999 181097.11829999834 210474.94829999655 181095.03330000117 210493.36029999703 181092.21730000153 210518.24549999833 181088.41230000183 210533.0020999983 181174.2875000015 210533.00450000167 181174.30110000074 210595.37189999968 181155.88589999825 210643.6120999977 181141.64169999957 210643.56210000068 181141.3482999988 210633.95809999853 181085.13769999892 210626.48809999973 181041.41169999912 210577.43289999664 181053.91490000114 210519.11230000108 181068.77980000153 210518.64350000024 181068.89930000156 210518.51720000058 181068.12970000133 210518.3601000011 181067.95809999853 210502.99750000238 180973.66809999943 210501.66809999943 180972.28810000047 210501.88350000232 180973.52270000055 210458.97609999776 180967.92110000178 210436.1740999967 180964.94429999962 210408.42490000278 180961.32229999825 210317.82630000263 180957.86169999838 210318.18930000067 180978.254900001 210317.5753000006 181005.46869999915 210317.12330000103 181025.49570000172 210319.94929999858 181049.57789999992 210321.31629999727 181061.23189999908 210323.40129999816 181079.00789999962 210323.64329999685 181081.06870000064 210326.61349999905 181106.37689999864 210327.03029999882 181109.92770000175 210352.50850000232 181106.5036999993 210370.33449999988 181222.35269999877 210441.56589999795 181201.39449999854</gml:posList></gml:LinearRing></gml:exterior></gml:Polygon></gml:surfaceMember><gml:surfaceMember><gml:Polygon><gml:exterior><gml:LinearRing><gml:posList>210597.9726999998 181365.30330000073 210578.05049999803 181337.22450000048 210564.6916999966 181336.63850000128 210539.5305000022 181346.3253000006 210489.21710000187 181266.68549999967 210488.0151000023 181264.7824999988 210464.80690000206 181228.0474999994 210467.05110000074 181226.71950000152 210460.55810000002 181206.8920999989 210460.44110000134 181206.53449999914 210404.59170000255 181223.1689000018 210404.59430000186 181223.1724999994 210427.65089999884 181256.40150000155 210451.73690000176 181291.11349999905 210507.2022999972 181371.05169999972 210536.12929999828 181412.7424999997 210554.83449999988 181439.70069999993 210615.96890000254 181397.97949999943 210597.9726999998 181365.30330000073</gml:posList></gml:LinearRing></gml:exterior></gml:Polygon></gml:surfaceMember><gml:surfaceMember><gml:Polygon><gml:exterior><gml:LinearRing><gml:posList>210550.13549999893 181442.9065000005 210502.17210000008 181374.89869999886 210420.49689999968 181259.0887000002 210405.28369999677 181266.61470000073 210400.0407000035 181266.85970000178 210401.1398999989 181269.95490000024 210404.4196999967 181279.18989999965 210410.377700001 181295.9679000005 210416.33869999647 181312.752700001 210422.46670000255 181330.00869999826 210428.49390000105 181346.9796999991 210433.27170000225 181360.43470000103 210434.06289999932 181362.66270000115 210435.42230000347 181366.49069999903 210435.4679000005 181366.61890000105 210435.59470000118 181366.97670000046 210441.95390000194 181384.88369999826 210466.39410000294 181375.56269999966 210470.06589999795 181385.9208999984 210477.1570999995 181405.92570000142 210478.71410000324 181410.31850000098 210445.9899000004 181422.64570000023 210453.8575000018 181431.35610000044 210454.29890000075 181431.84470000118 210457.7968999967 181435.7179000005 210461.58389999717 181439.91090000048 210471.77290000021 181451.19209999964 210471.87110000104 181451.30050000176 210476.50190000236 181457.27070000023 210477.68649999797 181458.79769999906 210490.21109999716 181474.94570000097 210494.7281000018 181480.7699000016 210498.66009999812 181485.8396999985 210500.77610000223 181488.56769999862 210515.3953000009 181507.4167000018 210525.94129999727 181521.01370000094 210569.43249999732 181479.95850000158 210567.06650000066 181476.26269999892 210571.16749999672 181472.7287000008 210550.13549999893 181442.9065000005</gml:posList></gml:LinearRing></gml:exterior></gml:Polygon></gml:surfaceMember></gml:MultiSurface>
'''

# Parse the GML data
root = etree.fromstring(gml_data.encode('utf-8'))
namespace = {'gml': 'http://www.opengis.net/gml/3.2'}
pos_list = root.find('.//gml:posList', namespaces=namespace).text.strip()

# Split the coordinates string into pairs
coords = pos_list.split()
coords_pairs = [(float(coords[i]), float(coords[i + 1])) for i in range(0, len(coords), 2)]

# Define the original and target projections
in_proj = Proj('epsg:31370')
out_proj = Proj('epsg:4326')

# Convert each coordinate and store the result
converted_coords = []
for x, y in coords_pairs:
    x2, y2 = transform(in_proj, out_proj, x, y)
    converted_coords.append((x2, y2))

api = overpy.Overpass()

# Form a polygon query string
coords_str = " ".join([f"{lat} {lon}" for lat, lon in converted_coords])

# Example Overpass query using a polygon
query = f"""
(
  node(poly:"{coords_str}");
  <;
);
out body;
"""

result = api.query(query)

# Print result
result
for node in result.nodes:
    print(f"Node ID: {node.id}, Lat: {node.lat}, Lon: {node.lon}")


